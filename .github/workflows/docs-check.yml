name: Documentation Check

on:
  pull_request:
    paths:
      - 'src/**/*.ts'
      - 'src/**/*.js'
      - '!src/**/__tests__/**'
      - '!**/*.test.ts'

permissions:
  pull-requests: write

jobs:
  check-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Check for documentation updates
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // Get list of changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            // Check if source files were modified
            const sourceFilesChanged = files.some(file =>
              (file.filename.startsWith('src/') &&
               (file.filename.endsWith('.ts') || file.filename.endsWith('.js')) &&
               !file.filename.includes('__tests__') &&
               !file.filename.endsWith('.test.ts'))
            );

            // Check if docs were updated
            const docsUpdated = files.some(file =>
              file.filename.endsWith('.md') ||
              file.filename.includes('docs/') ||
              file.filename === 'CLAUDE.md' ||
              file.filename === 'README.md'
            );

            // Check if this is labeled as docs-not-needed
            const hasLabel = pr.labels.some(label =>
              label.name === 'docs-not-needed' ||
              label.name === 'internal' ||
              label.name === 'test'
            );

            // If source files changed but docs weren't updated, add a comment
            if (sourceFilesChanged && !docsUpdated && !hasLabel) {
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number
              });

              const botComment = comments.data.find(comment =>
                comment.user.type === 'Bot' &&
                comment.body.includes('documentation updates')
              );

              if (!botComment) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: `ðŸ“š **Documentation Check**

This PR modifies source code but doesn't appear to update documentation.

**Please consider:**
- Updating relevant documentation in \`README.md\` or \`CLAUDE.md\`
- Adding code comments for complex logic
- Updating usage examples if APIs changed

If documentation updates aren't needed, add the \`docs-not-needed\` label to this PR.`
                });
              }
            }
